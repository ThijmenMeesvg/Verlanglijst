<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verlanglijst Admin</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 700px;
      margin: 3rem auto;
      padding: 2rem;
      background: #f9fafb;
      color: #111;
    }
    h1 { text-align: center; }
    label {
      font-weight: bold;
      display: block;
      margin-top: 1.5rem;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.6rem;
      font-size: 1rem;
      margin-top: 0.3rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    textarea {
      height: 120px;
      font-family: monospace;
      color: #333;
    }
    button {
      margin-top: 1rem;
      background-color: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background-color: #1d4ed8; }
    .result {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid #ddd;
    }
    .preview-card {
      margin-top: 2rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .preview-card img {
      width: 100px;
      border-radius: 8px;
    }
    .preview-card h3 { margin: 0 0 .3rem 0; }
    .preview-card p { margin: 0; }

    .loading {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      margin-top: 1rem;
    }
    .spinner {
      border: 4px solid #ddd;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-messages {
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 8px;
      background: #fee2e2;
      border: 1px solid #fca5a5;
      color: #991b1b;
      display: none;
    }
    .error-messages p { margin: 0.2rem 0; }
  </style>
</head>
<body>
  <section style="margin-top: 2rem; text-align: center;">
    <a href="https://github.com/thijmenmeesvg/Verlanglijst/blob/main/data.json" target="_blank" style="
        display: inline-block;
        padding: 0.6rem 1.2rem;
        background-color: #10b981;
        color: white;
        border-radius: 8px;
        font-weight: bold;
        text-decoration: none;
        transition: background-color 0.2s;"
      onmouseover="this.style.backgroundColor='#059669';"
      onmouseout="this.style.backgroundColor='#10b981';">
      Open GitHub Repo
    </a>
  </section>

  <section style="margin-top: 2rem; text-align: center;">
    <a href="index.html" style="
        display: inline-block;
        padding: 0.6rem 1.2rem;
        background-color: #FF8C42;
        color: white;
        border-radius: 8px;
        font-weight: bold;
        text-decoration: none;
        transition: background-color 0.2s;"
      onmouseover="this.style.backgroundColor='#FFD369';"
      onmouseout="this.style.backgroundColor='#FF8C42';">
      Terug naar Home
    </a>
  </section>

  <h1>üõ†Ô∏è Verlanglijst Admin</h1>

  <label for="category">Categorie:</label>
  <select id="category">
    <option>Boeken</option>
    <option>Muziek</option>
    <option>Spelletjes</option>
    <option>Kleding & Accesoires</option>
    <option>Uitzet</option>
    <option>Sport & Buiten</option>
    <option>Overig</option>
  </select>

  <label for="url">Product-URL:</label>
  <input id="url" type="url" placeholder="Plak hier de link van bol.com of ap.lc">

  <label for="favorite">
    <input type="checkbox" id="favorite"> Markeer als favoriet
  </label>

  <button id="generate">Genereer JSON-item</button>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <span>Laden...</span>
  </div>

  <div id="output" class="result" style="display:none;">
    <h2>Gegenereerd JSON-item:</h2>
    <textarea id="jsonResult"></textarea>
  </div>

  <div id="errorBox" class="error-messages"></div>

  <script>
    const accessCode = "verlanglijst"; 
    const enteredCode = prompt("Voer toegangscode in om deze adminpagina te openen:");
    if (enteredCode !== accessCode) {
      alert("Onjuiste code. Je wordt teruggestuurd naar de hoofdpagina.");
      window.location.href = "index.html";
    }

    document.getElementById("generate").addEventListener("click", async () => {
      const url = document.getElementById("url").value.trim();
      const category = document.getElementById("category").value;
      const isFavorite = document.getElementById("favorite").checked;
      const outputDiv = document.getElementById("output");
      const resultBox = document.getElementById("jsonResult");
      const loading = document.getElementById("loading");
      const errorBox = document.getElementById("errorBox");

      if (!url) return alert("Voer een geldige URL in.");

      outputDiv.style.display = "none";
      errorBox.style.display = "none";
      errorBox.innerHTML = "";
      loading.style.display = "flex";

      const today = new Date().toISOString().split("T")[0];
      const errors = [];

      let resolvedUrl = url;
      try {
        const r = await fetch(url, { redirect: "follow" });
        resolvedUrl = r.url || url;
      } catch {
        errors.push("Kon URL niet volgen ‚Äî mogelijk geblokkeerd door website.");
      }

      let html = "";
      try {
        const r = await fetch(resolvedUrl, { headers: { "User-Agent": "Mozilla/5.0" } });
        html = await r.text();
      } catch {
        errors.push("Pagina kon niet worden opgehaald (website blokkeerde toegang).");
      }

      // Slimmere fallback voor geblokkeerde sites
      let titleMatch = html.match(/<meta property="og:title" content="([^"]+)"/);
      let priceMatch = html.match(/"price":\s*"([\d.,]+)"/) || html.match(/‚Ç¨\s?([\d.,]+)/);
      let imageMatch = html.match(/<meta property="og:image" content="([^"]+)"/);

      let title = titleMatch ? titleMatch[1].trim() : "";
      if (!title && resolvedUrl.includes("bol.com")) {
        title = decodeURIComponent(resolvedUrl.split("/").pop().replace(/-/g, " ")).split("?")[0];
      }
      if (!title) errors.push("Titel kon niet worden opgehaald.");
      const price = priceMatch ? parseFloat(priceMatch[1].replace(",", ".")) : 0;
      if (!price) errors.push("Prijs kon niet worden opgehaald.");
      const image = imageMatch ? imageMatch[1] : "";
      if (!image) errors.push("Afbeelding kon niet worden opgehaald.");

      let shortUrl = resolvedUrl;
      try {
        const res = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(resolvedUrl)}`);
        shortUrl = await res.text();
      } catch {
        errors.push("Kon TinyURL niet genereren ‚Äî originele link gebruikt.");
      }

      const item = {
        title: title || "Onbekend product",
        price,
        link: shortUrl,
        favorite: isFavorite,
        dateAdded: today,
        image
      };

      const jsonResult = JSON.stringify(item, null, 2);
      resultBox.value = jsonResult;
      outputDiv.style.display = "block";
      loading.style.display = "none";

      let btn = document.getElementById("copyButton");
      if (!btn) {
        btn = document.createElement("button");
        btn.id = "copyButton";
        btn.textContent = "Kopieer JSON naar klembord";
        btn.onclick = async () => {
          await navigator.clipboard.writeText(resultBox.value);
          btn.textContent = "‚úÖ Gekopieerd!";
          setTimeout(() => (btn.textContent = "Kopieer JSON naar klembord"), 2500);
        };
        outputDiv.appendChild(btn);
      }

      const oldPreview = document.getElementById("previewCard");
      if (oldPreview) oldPreview.remove();

      const preview = document.createElement("div");
      preview.id = "previewCard";
      preview.className = "preview-card";

      if (image) {
        const img = document.createElement("img");
        img.src = image;
        img.alt = title;
        preview.appendChild(img);
      }

      const info = document.createElement("div");
      info.innerHTML = `
        <h3>${title || "Onbekend product"}</h3>
        <p>üí∂ ‚Ç¨${price ? price.toFixed(2) : "?"}</p>
        <a href="${resolvedUrl}" target="_blank" style="color:#2563eb;">Bekijk product</a>
        <p style="font-size:0.9rem;color:#555;margin-top:.4rem;">Categorie: ${category}</p>
        <p style="font-size:0.9rem;color:${isFavorite ? '#dc2626' : '#555'};">
          ${isFavorite ? "‚ù§Ô∏è Favoriet" : "ü§ç Niet favoriet"}
        </p>
      `;
      preview.appendChild(info);
      outputDiv.appendChild(preview);

      if (errors.length > 0) {
        errorBox.innerHTML = errors.map(e => `<p>‚ö†Ô∏è ${e}</p>`).join("");
        errorBox.style.display = "block";
      }
    });
  </script>
</body>
</html>
