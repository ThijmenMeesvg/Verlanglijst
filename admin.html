<script>
  document.getElementById("generate").addEventListener("click", async () => {
    const url = document.getElementById("url").value.trim();
    const category = document.getElementById("category").value;
    if (!url) return alert("Voer een geldige URL in.");

    const today = new Date().toISOString().split("T")[0];

    // Volg verkorte links (zoals ap.lc)
    const resolvedUrl = await fetch(url, { redirect: "follow" })
      .then(r => r.url)
      .catch(() => url);

    // Haal HTML op
    const html = await fetch(resolvedUrl, { headers: { "User-Agent": "Mozilla/5.0" } })
      .then(r => r.text())
      .catch(() => "");

    // Extract titel, prijs en afbeelding
    let titleMatch = html.match(/<meta property="og:title" content="([^"]+)"/);
    let priceMatch = html.match(/"price":\s*"([\d.,]+)"/) || html.match(/â‚¬\s?([\d.,]+)/);
    let imageMatch = html.match(/<meta property="og:image" content="([^"]+)"/);

    const title = titleMatch ? titleMatch[1].replace(/["']/g, '').trim() : "Onbekend product";
    const price = priceMatch ? parseFloat(priceMatch[1].replace(",", ".")) : 0;
    const image = imageMatch ? imageMatch[1] : null;

    // Verkort de URL automatisch via TinyURL
    let shortUrl = resolvedUrl;
    try {
      const res = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(resolvedUrl)}`);
      shortUrl = await res.text();
    } catch {
      console.warn("URL kon niet verkort worden, gebruik originele link.");
    }

    // Bouw JSON-item
    const item = {
      title,
      price,
      link: shortUrl,
      favorite: false,
      dateAdded: today
    };

    // Toon resultaat
    const jsonResult = JSON.stringify(item, null, 2);
    document.getElementById("output").style.display = "block";
    document.getElementById("jsonResult").value = jsonResult;

    // Voeg of update kopieerknop
    let btn = document.getElementById("copyButton");
    if (!btn) {
      btn = document.createElement("button");
      btn.id = "copyButton";
      btn.textContent = "Kopieer JSON naar klembord";
      btn.style.marginTop = "1rem";
      btn.onclick = async () => {
        await navigator.clipboard.writeText(jsonResult);
        btn.textContent = "âœ… Gekopieerd!";
        setTimeout(() => (btn.textContent = "Kopieer JSON naar klembord"), 2000);
      };
      document.getElementById("output").appendChild(btn);
    }

    // Verwijder vorige preview
    const oldPreview = document.getElementById("previewCard");
    if (oldPreview) oldPreview.remove();

    // Voeg visuele preview toe
    const preview = document.createElement("div");
    preview.id = "previewCard";
    preview.style.marginTop = "2rem";
    preview.style.padding = "1rem";
    preview.style.border = "1px solid #ddd";
    preview.style.borderRadius = "10px";
    preview.style.background = "#fff";
    preview.style.display = "flex";
    preview.style.gap = "1rem";
    preview.style.alignItems = "center";

    if (image) {
      const img = document.createElement("img");
      img.src = image;
      img.alt = title;
      img.style.width = "100px";
      img.style.borderRadius = "8px";
      preview.appendChild(img);
    }

    const info = document.createElement("div");
    info.innerHTML = `
      <h3 style="margin:0 0 .3rem 0;">${title}</h3>
      <p style="margin:0;">ðŸ’¶ â‚¬${price.toFixed(2)}</p>
      <a href="${resolvedUrl}" target="_blank" style="color:#2563eb;">Bekijk product</a>
      <p style="font-size:0.9rem;color:#555;margin-top:.4rem;">Categorie: ${category}</p>
    `;
    preview.appendChild(info);

    document.getElementById("output").appendChild(preview);
  });
</script>

