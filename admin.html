<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verlanglijst Admin</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    max-width: 1100px;
    margin: 2rem auto;
    padding: 2rem;
    background: #f3f4f6;
    color: #111;
  }
  h1, h2 { text-align: center; margin-bottom: 1rem; }
  label { font-weight: bold; display: block; margin-top: 1rem; }
  input, select, button {
    width: 100%; padding: 0.6rem; font-size: 1rem;
    margin-top: 0.3rem; border-radius: 8px; border: 1px solid #ccc;
  }
  button {
    margin-top: 1rem; background-color: #2563eb; color: white;
    border: none; cursor: pointer; border-radius: 8px;
    transition: background 0.3s, transform 0.2s;
  }
  button:hover { background-color: #1e40af; transform: translateY(-1px); }
  .section {
    background: white; padding: 2rem; margin-top: 2rem;
    border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  .error-box {
    margin-top: 1rem; padding: 0.8rem; border-radius: 8px;
    background: #fee2e2; border: 1px solid #fca5a5;
    color: #991b1b; display: none; white-space: pre-wrap;
  }
  .favorite-wrapper {
    display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;
  }
  .favorite-wrapper input { width: auto; transform: scale(1.3); cursor: pointer; }
  .favorite-wrapper label { margin-top: 0; font-weight: 500; }

  .loading-spinner {
    display: none; justify-content: center; align-items: center;
    margin-top: 1rem;
  }
  .spinner {
    border: 4px solid #ddd; border-top: 4px solid #2563eb;
    border-radius: 50%; width: 28px; height: 28px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .top-links {
    text-align: center; margin-bottom: 1rem;
  }
  .top-links a, .top-links button {
    display: inline-block; padding: 0.5rem 1rem;
    border-radius: 8px; text-decoration: none;
    font-weight: bold; margin: 0 0.3rem 0.3rem 0.3rem;
    border: none; cursor: pointer;
  }
  .home { background: #ff8c42; color: white; }
  .firebase { background: #fbbc04; color: black; }
  .logout { background: #ef4444; color: white; }
</style>
</head>
<body>

<div class="top-links">
  <a href="index.html" class="home">üè† Terug naar Home</a>
  <a href="https://console.firebase.google.com/project/verlanglijst-12015/database/verlanglijst-12015-default-rtdb/data" target="_blank" class="firebase">üåê Firebase Console</a>
  <button id="logoutBtn" class="logout">Log uit</button>
</div>

<h1>üõ†Ô∏è Verlanglijst Admin</h1>

<div class="section">
  <h2>‚öôÔ∏è Productinformatie</h2>

  <label for="category">Categorie:</label>
  <select id="category">
    <option value="">-- Kies categorie --</option>
    <option>Boeken</option>
    <option>Muziek</option>
    <option>Spelletjes</option>
    <option>Kleding & Accesoires</option>
    <option>Uitzet</option>
    <option>Sport & Buiten</option>
    <option>Overig</option>
  </select>

  <label>Product URL:</label>
  <input type="url" id="urlForm" placeholder="Plak hier de link">

  <label>Titel:</label>
  <input type="text" id="titleForm" placeholder="Titel verschijnt hier">

  <label>Prijs (‚Ç¨):</label>
  <input type="number" id="priceForm" placeholder="Prijs in ‚Ç¨">

  <label>Afbeelding URL:</label>
  <input type="url" id="imageForm" placeholder="Afbeelding link">

  <div class="favorite-wrapper">
    <input type="checkbox" id="favoriteForm">
    <label for="favoriteForm">Markeer als favoriet ‚ù§Ô∏è</label>
  </div>

  <label>Datum toegevoegd:</label>
  <input type="date" id="dateForm">

  <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
    <button id="populateFormBtn" style="flex:1;">Vul automatisch info in</button>
    <button id="addItemBtn" style="flex:1; background:#10b981;">Voeg toe aan Firebase</button>
    <button id="resetFormBtn" style="flex:1; background:#ef4444;">Leegmaken</button>
  </div>

  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
  </div>

  <div id="errorBox" class="error-box"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnDzhefAQWgoShNY2geSFwxTzNwqUqvTU",
    authDomain: "verlanglijst-12015.firebaseapp.com",
    databaseURL: "https://verlanglijst-12015-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "verlanglijst-12015",
    storageBucket: "verlanglijst-12015.firebasestorage.app",
    messagingSenderId: "512971362808",
    appId: "1:512971362808:web:b16ec8341ec4fbe795460d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Login
  const accessCode = "verlanglijst";
  if (localStorage.getItem("adminLoggedIn") !== "true") {
    const entered = prompt("Voer toegangscode in:");
    if (entered !== accessCode) {
      alert("Onjuiste code. Je wordt teruggestuurd.");
      window.location.href = "index.html";
    } else localStorage.setItem("adminLoggedIn", "true");
  }
  document.getElementById("logoutBtn").onclick = () => {
    localStorage.removeItem("adminLoggedIn");
    alert("Je bent uitgelogd.");
    window.location.href = "index.html";
  };

  const urlForm = document.getElementById("urlForm");
  const titleForm = document.getElementById("titleForm");
  const priceForm = document.getElementById("priceForm");
  const imageForm = document.getElementById("imageForm");
  const favoriteForm = document.getElementById("favoriteForm");
  const dateForm = document.getElementById("dateForm");
  const errorBox = document.getElementById("errorBox");
  const spinner = document.getElementById("loadingSpinner");

  const showError = msg => { errorBox.style.display="block"; errorBox.textContent=msg; };
  const clearError = () => { errorBox.style.display="none"; errorBox.textContent=""; };
  const showSpinner = state => { spinner.style.display = state ? "flex" : "none"; };

  // === Automatisch invullen (incl. JSON-LD fallback) ===
  document.getElementById("populateFormBtn").onclick = async () => {
    clearError(); showSpinner(true);
    const url = urlForm.value.trim();
    if (!url) { showSpinner(false); return showError("‚ö†Ô∏è Voer een product-URL in."); }

    let html = "";
    let errors = [];

    try {
      const res = await fetch(url, { mode: "cors" });
      html = await res.text();
    } catch {
      errors.push("‚ùå Kon de productpagina niet laden (CORS of ongeldig URL).");
    }

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    // --- JSON-LD fallback ---
    let jsonData;
    try {
      const scripts = [...doc.querySelectorAll('script[type="application/ld+json"]')];
      for (const s of scripts) {
        const parsed = JSON.parse(s.textContent);
        if (parsed["@type"] && (parsed["@type"].toLowerCase().includes("product") || parsed["@context"])) {
          jsonData = parsed;
          break;
        }
      }
    } catch {}

    // Titel
    const metaTitle = jsonData?.name || doc.querySelector('meta[property="og:title"]')?.content || doc.title;
    if (metaTitle) titleForm.value = metaTitle.trim();
    else { titleForm.value = ""; errors.push("‚ö†Ô∏è Kon titel niet ophalen."); }

    // Afbeelding
    const metaImg = jsonData?.image || doc.querySelector('meta[property="og:image"]')?.content ||
                    doc.querySelector('meta[name="twitter:image"]')?.content;
    if (metaImg) imageForm.value = typeof metaImg === "string" ? metaImg : metaImg[0];
    else { imageForm.value = ""; errors.push("‚ö†Ô∏è Kon afbeelding niet ophalen."); }

    // Prijs
    const text = html.replace(/\s+/g, " ");
    let priceValue =
      jsonData?.offers?.price ||
      (text.match(/"price"\s*:\s*"([\d.,]+)/)?.[1]) ||
      (text.match(/‚Ç¨\s?([\d.,]+)/)?.[1]) ||
      (text.match(/"priceAmount"\s*:\s*"([\d.,]+)/)?.[1]);
    if (priceValue) priceForm.value = parseFloat(priceValue.replace(",", "."));
    else { priceForm.value = ""; errors.push("‚ö†Ô∏è Kon prijs niet ophalen."); }

    dateForm.value = new Date().toISOString().slice(0, 10);

    showSpinner(false);
    if (errors.length) showError(errors.join("\n"));
  };

  // === Toevoegen met duplicaatcontrole ===
  document.getElementById("addItemBtn").onclick = async () => {
    clearError();
    const cat = document.getElementById("category").value;
    const link = urlForm.value.trim();
    if (!cat) return showError("‚ö†Ô∏è Kies eerst een categorie.");
    if (!link) return showError("‚ö†Ô∏è Vul een product-URL in.");

    try {
      const snapshot = await get(ref(db, "/" + cat));
      const data = snapshot.val() || {};
      const duplicate = Object.values(data).some(item =>
        item.link?.replace(/^https?:\/\//, "").toLowerCase() ===
        link.replace(/^https?:\/\//, "").toLowerCase()
      );
      if (duplicate) return showError("‚ö†Ô∏è Dit product staat al in de categorie \"" + cat + "\".");

      const item = {
        title: titleForm.value || "Onbekend product",
        price: priceForm.value ? parseFloat(priceForm.value) : 0,
        link: link,
        favorite: favoriteForm.checked,
        dateAdded: dateForm.value || new Date().toISOString().slice(0, 10),
        image: imageForm.value || "",
        done: false
      };
      await set(push(ref(db, "/" + cat)), item);
      resetForm();
    } catch (err) {
      showError("‚ùå Fout bij toevoegen aan Firebase: " + err.message);
    }
  };

  // === Reset formulier ===
  document.getElementById("resetFormBtn").onclick = () => resetForm();
  function resetForm() {
    document.getElementById("category").value = "";
    urlForm.value = "";
    titleForm.value = "";
    priceForm.value = "";
    imageForm.value = "";
    favoriteForm.checked = false;
    dateForm.value = "";
    clearError();
  }
</script>
</body>
</html>
